<div class="form-container">
  <div class="form-card">
    <div class="form-header">
      <h1>{{ isEditMode ? 'Editar Presupuesto' : 'Nuevo Presupuesto' }}</h1>
      <p class="subtitle">
        {{ isEditMode ? 'Actualiza los datos del presupuesto' : 'Crea un nuevo presupuesto para controlar tus gastos' }}
      </p>
    </div>

    <form (ngSubmit)="onSubmit()" #budgetForm="ngForm">
      <div class="form-body">
        
        <!-- Usuario (solo para administradores) - PRIMERO -->
        <div class="form-group user-selector-group" *ngIf="isAdmin">
          <label for="usuario">
            <span class="label-text">ğŸ‘¤ <strong>Usuario (Â¿Para quiÃ©n es este presupuesto?)</strong></span>
            <span class="required">*</span>
          </label>
          <select 
            id="usuario"
            name="usuarioId"
            [ngModel]="presupuesto.usuarioId"
            (ngModelChange)="onUsuarioChange($event)"
            required
            class="form-control user-select"
            [disabled]="loading || isEditMode">
            <option [ngValue]="0">-- Selecciona un usuario --</option>
            <option *ngFor="let user of usuarios" [ngValue]="user.id">
              ğŸ‘¤ {{ user.nombre }} - {{ user.correo }}
            </option>
          </select>
          <small *ngIf="isEditMode" class="help-text warning-text">
            â„¹ï¸ No se puede cambiar el usuario de un presupuesto existente
          </small>
          <small *ngIf="!isEditMode" class="help-text info-text">
            ğŸ’¡ Selecciona el usuario para quien deseas crear este presupuesto
          </small>
        </div>

        <div class="form-group">
          <label for="categoria">
            <span class="label-text">CategorÃ­a (Solo Gastos)</span>
            <span class="required">*</span>
          </label>
          <select 
            id="categoria"
            name="categoriaId"
            [ngModel]="presupuesto.categoriaId"
            (ngModelChange)="onCategoriaChange($event)"
            required
            class="form-control"
            [disabled]="loading">
            <option [ngValue]="0">Selecciona una categorÃ­a</option>
            <option *ngFor="let cat of categorias" [ngValue]="cat.id">
              {{ cat.nombre }}
            </option>
          </select>
        </div>

        <div class="form-group">
          <label for="monto">
            <span class="label-text">Monto LÃ­mite</span>
            <span class="required">*</span>
          </label>
          <div class="input-with-icon">
            <span class="icon">$</span>
            <input 
              type="number"
              id="monto"
              name="monto"
              [(ngModel)]="presupuesto.monto"
              required
              min="0.01"
              step="0.01"
              placeholder="0.00"
              class="form-control"
              [disabled]="loading">
          </div>
          <small class="help-text">
            Monto mÃ¡ximo que puedes gastar en esta categorÃ­a
          </small>
        </div>

        <div class="form-group">
          <label for="periodo">
            <span class="label-text">Periodo</span>
            <span class="required">*</span>
          </label>
          <div class="periodo-options">
            <label *ngFor="let p of periodos" class="radio-card">
              <input 
                type="radio"
                name="periodo"
                [value]="p"
                [(ngModel)]="presupuesto.periodo"
                required
                [disabled]="loading">
              <span class="radio-label">
                <span class="radio-icon">
                  {{ p === 'mensual' ? 'ğŸ“…' : 'ğŸ“†' }}
                </span>
                <span class="radio-text">{{ p | titlecase }}</span>
              </span>
            </label>
          </div>
        </div>

        <div class="info-box">
          <div class="info-icon">ğŸ’¡</div>
          <div class="info-content">
            <h4>Â¿CÃ³mo funcionan los presupuestos?</h4>
            <ul>
              <li>Se rastrearÃ¡n todos tus <strong>gastos</strong> en la categorÃ­a seleccionada</li>
              <li>RecibirÃ¡s alertas cuando te acerques al lÃ­mite establecido</li>
              <li>El periodo se reinicia automÃ¡ticamente (mensual o anual)</li>
            </ul>
          </div>
        </div>

      </div>

      <div class="form-footer">
        <button 
          type="button"
          (click)="onCancel()"
          class="btn btn-secondary"
          [disabled]="loading">
          Cancelar
        </button>
        <button 
          type="submit"
          class="btn btn-primary"
          [disabled]="!budgetForm.form.valid || loading">
          <span *ngIf="loading" class="spinner-small"></span>
          <span *ngIf="!loading">
            {{ isEditMode ? 'Actualizar' : 'Crear' }} Presupuesto
          </span>
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Modal de Presupuesto Duplicado -->
<app-duplicate-budget-modal
  [isOpen]="isDuplicateModalOpen"
  [categoryName]="duplicateData.categoryName"
  [existingAmount]="duplicateData.existingAmount"
  [existingPeriod]="duplicateData.existingPeriod"
  (close)="closeDuplicateModal()">
</app-duplicate-budget-modal>